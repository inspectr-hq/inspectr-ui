name: Notify Dependent Repo

on:
  release:
    types: [published]

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch release event to inspectr-app
        env:
          REPO_Y_DISPATCH_TOKEN: ${{ secrets.REPO_Y_DISPATCH_TOKEN }}
          VERSION: ${{ github.event.release.tag_name }}
          SOURCE_REPO: ${{ github.repository }}
          RELEASE_URL: ${{ github.event.release.html_url }}
        run: |
          set -euo pipefail
          : "${REPO_Y_DISPATCH_TOKEN:?REPO_Y_DISPATCH_TOKEN secret is required}"

          curl -fsS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${REPO_Y_DISPATCH_TOKEN}" \
            https://api.github.com/repos/thim81/inspectr-app/dispatches \
            -d "$(cat <<EOF
          {
            \"event_type\": \"repo-x-released\",
            \"client_payload\": {
              \"version\": \"${VERSION}\",
              \"repo\": \"${SOURCE_REPO}\",
              \"release_url\": \"${RELEASE_URL}\"
            }
          }
          EOF
          )"
