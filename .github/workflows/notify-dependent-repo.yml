name: Notify Dependent Repo

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to dispatch (e.g. 1.8.2)'
        required: true

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch release event to inspectr-app
        env:
          REPO_Y_DISPATCH_TOKEN: ${{ secrets.REPO_Y_DISPATCH_TOKEN }}
          VERSION: ${{ github.event.release.tag_name || github.event.inputs.version }}
          SOURCE_REPO: ${{ github.repository }}
          RELEASE_URL: ${{ github.event.release.html_url || format('https://github.com/{0}/releases/tag/v{1}', github.repository, github.event.inputs.version) }}
        run: |
          set -euo pipefail
          : "${REPO_Y_DISPATCH_TOKEN:?REPO_Y_DISPATCH_TOKEN secret is required}"

          curl -fsS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${REPO_Y_DISPATCH_TOKEN}" \
            https://api.github.com/repos/inspectr-hq/inspectr-app/dispatches \
            -d "$(cat <<EOF
          {
            "event_type": "repo-released",
            "client_payload": {
              "version": "${VERSION}",
              "repo": "${SOURCE_REPO}",
              "release_url": "${RELEASE_URL}"
            }
          }
          EOF
          )"
